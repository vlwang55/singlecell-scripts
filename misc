##### READING IN DIFFERENT FILE TYPES #####
# mtx file
mtx_obj <- ReadMtx(mtx = "matrix.mtx.gz",
                   features = "features.tsv.gz",
                   cells = "barcodes.tsv.gz")
obj <- CreateSeuratObject(counts = mtx_obj)

# csv file
meta <- read.table(file = 'newmetadata.csv', sep = ',', header = TRUE)

# hdf5 file
inputdata.10x <- Read10X_h5("filtered_feature_bc_matrix.h5")
fragpath <- "/pathtofile/atac_fragments.tsv.gz"
rna_counts <- inputdata.10x$`Gene Expression`
obj <- CreateSeuratObject(counts = rna_counts, project = "ProjName")

# h5ad file
library(SeuratDisk)
Convert("adata.h5ad", ".h5seurat")
obj <- LoadH5Seurat("adata.h5seurat")
Convert("adata.h5ad", dest = "h5seurat", overwrite = TRUE)


##### ADDING METADATA CATEGORIES TO YOUR OBJECT BASED ON CELL BARCODES #####
# If you want to transfer the identities in one object to another that has the same cells
obj1 <- subset(obj1, idents = 'New')
obj1names <- colnames(obj1)

# Check to make sure your barcodes are the same i.e. nothing else added
head(colnames(obj1))
head(colnames(obj2))

# If the barcodes were modified in any way you can insert (paste0) to match or delete (..$) to subtract characters
obj1names <- sub("..$", "", obj1names)
names(obj1names) <- paste0(names(obj1names),"_1")

# Now you can add the barcodes with identities to the new object's meta data
obj2names <- cbind(obj1names, as.matrix(obj1@meta.data$New))
rownames(obj2names) <- obj2names[,1]
obj2names <- obj2names[,-1]
obj2 <- AddMetaData(obj2, metadata = c(obj2names), col.name = 'New')
DimPlot(obj2, idents = 'New)

# BONUS - can use this to subset out cells based on gene expression counts
Ins1 <- names(which((beta@assays[["SCT"]]@data['Ins1',] > 5)))


##### VISUALIZING PCA DIMENSIONS #####
DimHeatmap(mouse, dims = 1, cells = 500, balanced = TRUE)


##### SPECIFYING COLORS #####
show_col(hue_pal()(12))
DimPlot(CCPPtest, pt.size = 1, group.by = "SubOrigIdents",cols = c("#00BFC4", "#F8766D","#7CAE00"))


##### DEFINING ORDERED LEVELS OF CLUSTER IDENTITIES #####
my_levels <- c('NP_1', 'NP_2', 'E8_1', 'E8_2', 'E14_1', 'E14_2', 'E17_1', 'E17_3', 'MP_1')
obj$orig.ident <- factor(x = obj$orig.ident, levels = my_levels)


##### MAKING A VARIABILITY PLOT #####
# This is based on the HVG or high variability genes calculated during SCTransform

# Load libraries
library(Seurat)
library(dplyr)
library(ggplot2)

# OPTIONAL you might need to increase your processing power
options(future.globals.maxSize = 2891289600)

obj <- SCTransform(
  obj,
  assay = "RNA",                    # Need to use raw RNA counts
  new.assay.name = "SCT",
  return.only.var.genes = FALSE,    # MUST be FALSE to get HVG diagnostics
  conserve.memory = FALSE,          # ensures full model stored
  verbose = TRUE
)

hvg <- VariableFeatures(obj)
expr <- GetAssayData(obj, assay = "SCT", layer = "data")

# Compute variance for HVGs
var_hvg <- apply(expr[hvg, ], 1, var)

# Plot variance-ranked HVGs
var_df <- data.frame(
  gene = hvg,
  variance = var_hvg
)

var_df <- var_df[order(var_df$variance, decreasing = TRUE), ]
var_df$rank <- seq_len(nrow(var_df))

ggplot(var_df, aes(x = rank, y = variance)) +
  geom_line() +
  theme_classic() +
  xlab("Ranked HVGs") +
  ylab("Variance") +
  ggtitle("Scree-like plot using HVGs")

# Get variable features with their variance
vf <- HVFInfo(merge) %>%
  arrange(desc(variance.standardized))

# Compute cumulative variance explained
vf$cumvar <- cumsum(vf$variance.standardized) / sum(vf$variance.standardized)

# Plot: cumulative variance vs number of genes
ggplot(vf, aes(x = seq_along(cumvar), y = cumvar)) +
  geom_line() +
  labs(x = "Number of genes included",
       y = "Cumulative variance explained",
       title = "How variance decreases as more variable genes are included") +
  theme_classic()


##### HOW TO CHANGE ENSEMBL TO GENE SYMBOL #####
# For mice
library(biomaRt)

ensembl <- useDataset("mmusculus_gene_ensembl", mart = ensembl)
vals <- unique(ctrl$Feature)
gene_annotations <- getBM(
  attributes = c('mgi_symbol', 'ensembl_gene_id'),
  filters = 'mgi_symbol',
  values = vals,
  mart = ensembl)

exonlength <- merge(ctrl, gene_annotations, by.x = "Feature", by.y = "mgi_symbol")
dim(exonlength)
symbol <- exonlength[,1995]
head(symbol)
exonlength2 <- cbind(symbol, exonlength)
ctrl <- exonlength2
vals <- unique(ctrl$symbol)

gene_annotations <- getBM(
  attributes = c('ensembl_gene_id', 'external_gene_name'),
  filters = 'ensembl_gene_id',
  values = vals,
  mart = ensembl)


# For human
tr2g <- read_tsv("transcripts_to_genes_ms.txt", col_names = c("transcript", "gene", "gene_symbol")) %>%
  select(-transcript) %>%
  distinct()

rownames(res_mat) <- tr2g$gene_symbol[match(rownames(res_mat), tr2g$gene)]
uniquerowname <- unique(rownames(res_mat))
res_mat2 <- res_mat[uniquerowname,]
dim(res_mat2)
seu <- CreateSeuratObject(res_mat2)
